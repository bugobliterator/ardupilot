# hw definition file for processing by chibios_hwdef.py
# for H743 bootloader

# MCU class and specific type
MCU STM32H7xx STM32H757xx

define CORE_CM7
define SMPS_PWR

define WATCHDOG_DISABLED

# crystal frequency
OSCILLATOR_HZ 24000000

# board ID for firmware load
APJ_BOARD_ID 1402

FLASH_SIZE_KB 2048

# setup build for a peripheral firmware
env AP_PERIPH 1
define PERIPH_FW TRUE
define HAL_BUILD_AP_PERIPH
define HAL_NO_GCS
define HAL_LOGGING_ENABLED 0
define HAL_NO_MONITOR_THREAD

# bootloader is installed on first 128k sector
FLASH_RESERVE_START_KB 128

# the location where the bootloader will put the firmware
# the H743 has 128k sectors
FLASH_BOOTLOADER_LOAD_KB 128

define HAL_LED_ON 0

# order of UARTs (and USB)
SERIAL_ORDER OTG1 USART1

PB15 USART1_RX USART1
PB14 USART1_TX USART1

PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

I2C_ORDER I2C1

# I2C line with BQ76920
PB7 I2C1_SDA I2C1
PB6 I2C1_SCL I2C1

define AP_BATTMONITOR_BQ769x0_BUS_INTERNAL 0
define HAL_BQ769X0_NUM_CELLS 4

# now we define the pins that USB is connected on
PA11 OTG_FS_DM OTG1
PA12 OTG_FS_DP OTG1

PB5 BQ769x0_ALERT INPUT PULLDOWN GPIO(100)
PA0 POWER_BUTTON INPUT PULLDOWN GPIO(101)
PA15 BQ76920_MODE OUTPUT HIGH GPIO(102)
PB0 LED OUTPUT HIGH GPIO(103)
PB1 LED1 OUTPUT HIGH GPIO(104)
PB2 LED2 OUTPUT HIGH GPIO(105)
PC4 LED3 OUTPUT HIGH GPIO(106)
PC14 LED4 OUTPUT HIGH GPIO(107)
PB3 LED5 OUTPUT HIGH GPIO(108)
PB4 LED6 OUTPUT HIGH GPIO(109)
PB12 LED7 OUTPUT HIGH GPIO(110)
PB13 LED7 OUTPUT HIGH GPIO(111)


PA2 CHARGING_WAKE INPUT PULLDOWN GPIO(112)

define HAL_GPIO_BQ769x0_ALERT 100
define HAL_GPIO_POWER_BUTTON 101
define HAL_GPIO_MODE 102
define HAL_GPIO_CHARGING 108

define HAL_GPIO_LED1 104
define HAL_GPIO_LED2 105
define HAL_GPIO_LED3 106
define HAL_GPIO_LED4 107

PC2 BAT_ADC ADC1

define AP_BATT_CAPACITY_MAH_DEFAULT 1300

# the first CAN bus
PB8 CAN1_RX CAN1
PB9 CAN1_TX CAN1
PC8 GPIO CAN_SLEEP OUTPUT LOW

PA6 GPIO COM_DET INPUT FLOATING
PA7 GPIO COM_SW1 OUTPUT LOW
PA8 GPIO COM_SW2 OUTPUT HIGH

I2C_SLAVE I2C2
PB10 I2C2_SCL I2C2  
PB11 I2C2_SDA I2C2

define HAL_USE_EMPTY_STORAGE 1
define HAL_STORAGE_SIZE 16384

# reserve 256 bytes for comms between app and bootloader
RAM_RESERVE_START 256

define HAL_PERIPH_ENABLE_BATTMON

# use DNA
define HAL_CAN_DEFAULT_NODE_ID 0

env APP_DESCRIPTOR MissionPlanner

define CAN_APP_NODE_NAME "org.cubepilot.CubeBrick"

define AP_BATT_MONITOR_MANUFACTURER_NAME "CubePilot"
define AP_BATT_MONITOR_DEVICE_NAME "CubeBrick"
